<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kink Negotiator Master v6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        .category-block { background: var(--card); border-radius: 8px; margin-bottom: 12px; border: 1px solid #333; overflow: hidden; }
        .category-header { background: #2c2c2c; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); }
        .category-content { display: none; padding: 10px; overflow-x: auto; }
        .category-content.open { display: block; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; min-width: 600px; }
        th { background: #333; padding: 10px; border: 1px solid #444; }
        td { border: 1px solid #333; padding: 8px; text-align: center; }
        .act-name { text-align: left; width: 35%; font-weight: bold; position: relative; cursor: help; border-bottom: 1px dashed #555; }
        
        /* Interactive Tooltip */
        .act-name:hover::after {
            content: attr(data-tooltip);
            position: absolute; left: 0; top: 100%;
            background: #2c2c2c; color: #fff; padding: 12px; border-radius: 6px;
            width: 280px; z-index: 100; font-weight: normal; font-size: 0.85em;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6); border: 1px solid var(--primary);
        }

        .m-3 { background: #f1c40f; color: #000; } 
        .m-4 { background: #2ecc71; color: #000; }
        .m-5 { background: #9b59b6; color: #fff; }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: #333; border-radius: 5px; cursor: pointer; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; }

        input, select, textarea { background: #000; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; font-size: 1rem; }
        button { padding: 14px 28px; background: var(--accent); border:none; border-radius:6px; font-weight:bold; cursor: pointer; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
    </style>
</head>
<body>

    <h1>Kink Negotiator Matrix</h1>

    <div class="nav-tabs">
        <div class="tab active" onclick="showPage('survey-page', this)">1. Survey</div>
        <div class="tab" onclick="showPage('matrix-page', this)">2. Comparison Matrix</div>
    </div>

    <div id="survey-page" class="page active">
        <div class="category-block" style="padding: 15px;">
            <label>Your Name: </label>
            <input type="text" id="userName" placeholder="e.g. Jack">
            <p><small>Click Category headers to expand. Hover over names for definitions.</small></p>
        </div>
        
        <div id="survey-container"></div>
        
        <div style="text-align: center; margin: 40px 0;">
            <button onclick="generateShortCode()">Generate Shareable Code</button>
            <div id="outputContainer" style="display:none; margin-top: 20px;">
                <p><strong>Your Encrypted String (Tier 1):</strong></p>
                <div id="outputCode" style="word-break: break-all; background: #000; padding: 20px; border: 1px dashed var(--primary); font-family: monospace; font-size: 0.8em; color: var(--accent);"></div>
            </div>
        </div>
    </div>

    <div id="matrix-page" class="page">
        <div class="category-block" style="padding: 20px;">
            <p>Paste codes from your partners (one per line):</p>
            <textarea id="compareBox" style="width: 100%; height: 120px;" placeholder="Paste strings here..."></textarea>
            <button onclick="runComparison()" style="margin-top: 15px; background: var(--primary); color: #000;">Analyze Group Matrix</button>
        </div>
        <div id="matrix-results"></div>
    </div>

<script>
    // --- MASTER LIST DATA ---
    const masterData = {
        "Essentials": [
            { id: "E01", name: "Aftercare", desc: "The physical and emotional care provided after a high-intensity scene to ensure everyone feels safe and grounded." },
            { id: "E02", name: "Safe Words", desc: "Using predetermined signals (Red/Yellow/Green) to communicate limits during play." }
        ],
        "Impact Play": [
            { id: "I01", name: "Spanking", desc: "Striking the buttocks with an open hand or a flat implement for sensation or discipline." },
            { id: "I02", name: "Cane/Wand Play", desc: "High-intensity impact using thin, stingy implements." }
        ],
        "Sensation": [
            { id: "S01", name: "Blindfolds", desc: "Removing sight to heighten other senses and increase anticipation." },
            { id: "S02", name: "Wax Play", desc: "Dripping low-temperature candle wax onto the skin for sensory stimulation." }
        ]
    };

    // --- RENDER SURVEY ---
    const container = document.getElementById('survey-container');
    for (const [category, items] of Object.entries(masterData)) {
        let sectionHtml = `
            <div class="category-block">
                <div class="category-header" onclick="toggleCat(this)">${category} <span>+</span></div>
                <div class="category-content">
                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2">Activity</th>
                                <th colspan="2" style="background:#3700b3;color:#fff;">GIVING</th>
                                <th colspan="2" style="background:#3700b3;color:#fff;">RECEIVING</th>
                            </tr>
                            <tr>
                                <th>Hist</th><th>Int</th><th>Hist</th><th>Int</th>
                            </tr>
                        </thead>
                        <tbody>`;
        
        items.forEach(item => {
            sectionHtml += `
                <tr>
                    <td class="act-name" data-tooltip="${item.desc}">${item.name}</td>
                    <td><input type="checkbox" class="hist-check" id="gh-${item.id}"></td>
                    <td>
                        <select id="gs-${item.id}">
                            ${[1,2,3,4,5].map(v => `<option value="${v}" ${v==3?'selected':''}>${v}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="checkbox" class="hist-check" id="rh-${item.id}"></td>
                    <td>
                        <select id="rs-${item.id}">
                            ${[1,2,3,4,5].map(v => `<option value="${v}" ${v==3?'selected':''}>${v}</option>`).join('')}
                        </select>
                    </td>
                </tr>`;
        });
        sectionHtml += `</tbody></table></div></div>`;
        container.innerHTML += sectionHtml;
    }

    // --- UI LOGIC ---
    function toggleCat(el) {
        const content = el.nextElementSibling;
        content.classList.toggle('open');
        el.querySelector('span').innerText = content.classList.contains('open') ? '-' : '+';
    }

    function showPage(pageId, tabEl) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        tabEl.classList.add('active');
    }

    // --- DATA LOGIC ---
    function generateShortCode() {
        const name = document.getElementById('userName').value || "Anon";
        const responses = {};
        
        // Loop through all items across all categories
        Object.values(masterData).forEach(items => {
            items.forEach(item => {
                responses[item.id] = [
                    document.getElementById(`gh-${item.id}`).checked ? 1 : 0,
                    parseInt(document.getElementById(`gs-${item.id}`).value),
                    document.getElementById(`rh-${item.id}`).checked ? 1 : 0,
                    parseInt(document.getElementById(`rs-${item.id}`).value)
                ];
            });
        });

        const jsonStr = JSON.stringify({ n: name, r: responses });
        const compressed = pako.deflate(jsonStr);
        const base64 = btoa(String.fromCharCode.apply(null, compressed));
        
        document.getElementById('outputCode').innerText = base64;
        document.getElementById('outputContainer').style.display = 'block';
    }

    function runComparison() {
        const raw = document.getElementById('compareBox').value.trim();
        if (!raw) return;
        
        const codes = raw.split('\n');
        const participants = codes.map(c => {
            try {
                const bin = new Uint8Array(atob(c.trim()).split('').map(x => x.charCodeAt(0)));
                return JSON.parse(pako.inflate(bin, { to: 'string' }));
            } catch(e) { return null; }
        }).filter(p => p !== null);

        if (participants.length === 0) return;

        let resultHtml = "<table><thead><tr><th rowspan='2'>Activity</th>";
        participants.forEach(p => resultHtml += `<th colspan='2' style='background: #3700b3; color:#fff;'>${p.n}</th>`);
        resultHtml += "</tr><tr>";
        participants.forEach(() => resultHtml += "<th>Give</th><th>Rec</th>");
        resultHtml += "</tr></thead><tbody>";

        // Loop through the master list to build the matrix
        Object.values(masterData).forEach(items => {
            items.forEach(item => {
                let rowHtml = `<tr><td class='act-name' data-tooltip="${item.desc}">${item.name}</td>`;
                let isRelevant = false;

                participants.forEach(p => {
                    const d = p.r[item.id] || [0, 1, 0, 1]; // Fallback for missing IDs
                    if (d[1] >= 3 || d[3] >= 3) isRelevant = true;
                    rowHtml += `<td class="m-${d[1]}">${d[1] >= 3 ? d[1] : ''}</td>`;
                    rowHtml += `<td class="m-${d[3]}">${d[3] >= 3 ? d[3] : ''}</td>`;
                });

                if (isRelevant) resultHtml += rowHtml + "</tr>";
            });
        });

        document.getElementById('matrix-results').innerHTML = resultHtml + "</tbody></table>";
    }
</script>
</body>
</html>
