<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kink Negotiator - Master v5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* Category Styling */
        .category-block { background: var(--card); border-radius: 8px; margin-bottom: 12px; border: 1px solid #333; overflow: hidden; }
        .category-header { background: #2c2c2c; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); }
        .category-content { display: none; padding: 10px; overflow-x: auto; }
        .category-content.open { display: block; }
        
        /* Table Styling */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; min-width: 600px; }
        th { background: #333; padding: 10px; border: 1px solid #444; }
        td { border: 1px solid #333; padding: 8px; text-align: center; }
        .act-name { text-align: left; width: 35%; font-weight: bold; position: relative; cursor: help; }
        
        /* Tooltip Styling */
        .act-name:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 0; top: 100%;
            background: #444; color: #fff;
            padding: 10px; border-radius: 4px;
            width: 250px; z-index: 10;
            font-weight: normal; font-size: 0.85em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
        }

        /* Interest Colors */
        .m-3 { background: #f1c40f; color: #000; } 
        .m-4 { background: #2ecc71; color: #000; }
        .m-5 { background: #9b59b6; color: #fff; }

        /* Navigation */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: #333; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; }

        input, select, textarea { background: #000; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; }
        button { padding: 12px 24px; background: var(--accent); border:none; border-radius:5px; font-weight:bold; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Kink Negotiator Master</h1>

    <div class="nav-tabs">
        <div class="tab active" onclick="showPage('survey-page', this)">1. Survey</div>
        <div class="tab" onclick="showPage('matrix-page', this)">2. Comparison Matrix</div>
    </div>

    <div id="survey-page" class="page active">
        <div class="category-block" style="padding: 15px;">
            <label>Your Name: </label>
            <input type="text" id="userName" placeholder="e.g. Jack">
            <p><small>Hover over activity names to see descriptions.</small></p>
        </div>
        
        <div id="survey-container"></div>
        
        <div style="text-align: center; margin: 30px;">
            <button onclick="generateShortCode()">Generate Shareable Code</button>
            <div id="outputContainer" style="display:none; margin-top: 15px;">
                <p><strong>Your Code:</strong></p>
                <div id="outputCode" style="word-break: break-all; background: #000; padding: 15px; border: 1px dashed var(--primary); font-family: monospace;"></div>
            </div>
        </div>
    </div>

    <div id="matrix-page" class="page">
        <div class="category-block" style="padding: 20px;">
            <p>Paste codes from your group (one per line):</p>
            <textarea id="compareBox" style="width: 100%; height: 100px;"></textarea>
            <button onclick="runComparison()" style="margin-top: 15px; background: var(--primary); color: #000;">Generate Matrix</button>
        </div>
        <div id="matrix-results"></div>
    </div>

<script>
    // DATA STRUCTURE WITH TOOLTIPS
    const masterData = {
        "General": [
            { id: "G01", name: "Oral Sex", desc: "Sexual activity involving the stimulation of the genitalia by the mouth of another person." },
            { id: "G02", name: "Intercourse", desc: "Traditional penetrative sexual activity." }
        ],
        "Impact Play": [
            { id: "I01", name: "Spanking", desc: "Striking the buttocks with an open hand or a flat implement for sensation or discipline." },
            { id: "I02", name: "Flogging", desc: "The use of multi-tailed whips to create a thuddy or stingy sensation across the body." }
        ],
        "Bondage": [
            { id: "B01", name: "Rope Bondage", desc: "The artistic or functional use of rope to restrict movement or create aesthetic patterns." },
            { id: "B02", name: "Handcuffs", desc: "Metal or soft restraints used to secure the wrists together or to furniture." }
        ]
    };

    // Render Survey
    const container = document.getElementById('survey-container');
    for (const [cat, items] of Object.entries(masterData)) {
        let catHtml = `
            <div class="category-block">
                <div class="category-header" onclick="toggleCat(this)">${cat} <span>+</span></div>
                <div class="category-content">
                    <table>
                        <tr>
                            <th rowspan="2">Activity</th>
                            <th colspan="2" style="background:#3700b3;color:#fff;">GIVING</th>
                            <th colspan="2" style="background:#3700b3;color:#fff;">RECEIVING</th>
                        </tr>
                        <tr>
                            <th>Hist</th><th>Int</th><th>Hist</th><th>Int</th>
                        </tr>`;
        
        items.forEach(item => {
            catHtml += `
                <tr>
                    <td class="act-name" data-tooltip="${item.desc}">${item.name}</td>
                    <td><input type="checkbox" id="gh-${item.id}"></td>
                    <td><select id="gs-${item.id}">${[1,2,3,4,5].map(v=>`<option value="${v}" ${v==3?'selected':''}>${v}</option>`).join('')}</select></td>
                    <td><input type="checkbox" id="rh-${item.id}"></td>
                    <td><select id="rs-${item.id}">${[1,2,3,4,5].map(v=>`<option value="${v}" ${v==3?'selected':''}>${v}</option>`).join('')}</select></td>
                </tr>`;
        });
        catHtml += `</table></div></div>`;
        container.innerHTML += catHtml;
    }

    function toggleCat(el) {
        const content = el.nextElementSibling;
        content.classList.toggle('open');
        el.querySelector('span').innerText = content.classList.contains('open') ? '-' : '+';
    }

    function showPage(pageId, tabEl) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        tabEl.classList.add('active');
    }

    function generateShortCode() {
        const name = document.getElementById('userName').value || "Anon";
        const responses = {};
        Object.values(masterData).flat().forEach(item => {
            responses[item.id] = [
                document.getElementById(`gh-${item.id}`).checked ? 1 : 0,
                parseInt(document.getElementById(`gs-${item.id}`).value),
                document.getElementById(`rh-${item.id}`).checked ? 1 : 0,
                parseInt(document.getElementById(`rs-${item.id}`).value)
            ];
        });
        const blob = pako.deflate(JSON.stringify({ n: name, r: responses }));
        const code = btoa(String.fromCharCode.apply(null, blob));
        document.getElementById('outputCode').innerText = code;
        document.getElementById('outputContainer').style.display = 'block';
    }

    function runComparison() {
        const codes = document.getElementById('compareBox').value.trim().split('\n');
        const participants = codes.map(c => {
            try {
                const bin = new Uint8Array(atob(c.trim()).split('').map(x => x.charCodeAt(0)));
                return JSON.parse(pako.inflate(bin, { to: 'string' }));
            } catch(e) { return null; }
        }).filter(p => p !== null);

        if (participants.length === 0) return;

        let html = "<table><thead><tr><th rowspan='2'>Activity</th>";
        participants.forEach(p => html += `<th colspan='2' style='background: #3700b3; color:#fff;'>${p.n}</th>`);
        html += "</tr><tr>";
        participants.forEach(() => html += "<th>Give</th><th>Rec</th>");
        html += "</tr></thead><tbody>";

        Object.values(masterData).flat().forEach(item => {
            let row = `<tr><td class='act-name' data-tooltip="${item.desc}">${item.name}</td>`;
            let showRow = false;
            participants.forEach(p => {
                const d = p.r[item.id];
                if (d[1] >= 3
